# æ–‡ä»¶å: .github/workflows/build-windows-test.yml

name: "ğŸš€ Build Test for Windows Flutter"

# è§¦å‘æ¡ä»¶:
# 1. 'workflow_dispatch': å…è®¸ä½ åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨ç‚¹å‡» "Run workflow"ã€‚
# 2. 'push': (å·²æ³¨é‡Šæ‰) å¦‚æœéœ€è¦ï¼Œå¯ä»¥å–æ¶ˆæ³¨é‡Šï¼Œåœ¨æ¨é€åˆ°ç‰¹å®šåˆ†æ”¯æ—¶è‡ªåŠ¨è¿è¡Œã€‚
on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - main

# å¤åˆ¶äº†ä¸»æ–‡ä»¶ä¸­çš„æ‰€æœ‰å…¨å±€ç¯å¢ƒå˜é‡ï¼Œä»¥ç¡®ä¿æ„å»ºç¯å¢ƒä¸€è‡´
env:
  SCITER_RUST_VERSION: "1.75"
  RUST_VERSION: "1.75"
  MAC_RUST_VERSION: "1.81"
  CARGO_NDK_VERSION: "3.1.2"
  SCITER_ARMV7_CMAKE_VERSION: "3.29.7"
  SCITER_NASM_DEBVERSION: "2.15.05-1"
  LLVM_VERSION: "15.0.6"
  FLUTTER_VERSION: "3.24.5"
  ANDROID_FLUTTER_VERSION: "3.24.5"
  FLUTTER_ELINUX_VERSION: "3.16.9"
  TAG_NAME: "test-build"
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"
  ARMV7_VCPKG_COMMIT_ID: "6f29f12e82a8293156836ad81cc9bf5af41fe836"
  VERSION: "1.4.2"
  NDK_VERSION: "r27c"
  ANDROID_SIGNING_KEY: "${{ secrets.ANDROID_SIGNING_KEY }}"
  MACOS_P12_BASE64: "${{ secrets.MACOS_P12_BASE64 }}"
  UPLOAD_ARTIFACT: "true" # ä¿æŒä¸º true ä»¥ä¾¿ä¸Šä¼ æ„å»ºäº§ç‰©
  SIGN_BASE_URL: "${{ secrets.SIGN_BASE_URL }}"
  RS_PUB_KEY: "${{ secrets.RS_PUB_KEY }}"
  RENDEZVOUS_SERVER: "${{ secrets.RENDEZVOUS_SERVER }}"

jobs:
  # ä¾èµ–é¡¹ 1: generate-bridge
  # æ³¨æ„: è¿™ä¾èµ–äºä½ ä»“åº“ä¸­ .github/workflows/bridge.yml æ–‡ä»¶çš„å­˜åœ¨
  generate-bridge:
    uses: ./.github/workflows/bridge.yml

  # ä¾èµ–é¡¹ 2: build-RustDeskTempTopMostWindow
  # æ³¨æ„: è¿™ä¾èµ–äºä½ ä»“åº“ä¸­ .github/workflows/third-party-RustDeskTempTopMostWindow.yml æ–‡ä»¶çš„å­˜åœ¨
  build-RustDeskTempTopMostWindow:
    uses: ./.github/workflows/third-party-RustDeskTempTopMostWindow.yml
    with:
      upload-artifact: true # å¿…é¡»ä¸º trueï¼Œå› ä¸ºä¸»æ„å»ºéœ€è¦è¿™ä¸ªäº§ç‰©
      target: windows-2022
      configuration: Release
      platform: x64
      target_version: Windows10

  # ä¸»è¦çš„ Windows æ„å»ºä»»åŠ¡
  build-for-windows-flutter:
    name: "Build for x86_64-pc-windows-msvc"
    needs: [build-RustDeskTempTopMostWindow, generate-bridge]
    runs-on: windows-2022
    steps:
      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v6
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Restore bridge files
        uses: actions/download-artifact@master
        with:
          name: bridge-artifact
          path: ./

      - name: Install LLVM and Clang
        uses: KyleMayes/install-llvm-action@v1
        with:
          version: ${{ env.LLVM_VERSION }}

      - name: Install flutter
        uses: subosito/flutter-action@v2.12.0
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Replace engine with rustdesk custom flutter engine
        run: |
          flutter doctor -v
          flutter precache --windows
          Invoke-WebRequest -Uri https://github.com/rustdesk/engine/releases/download/main/windows-x64-release.zip -OutFile windows-x64-release.zip
          Expand-Archive -Path windows-x64-release.zip -DestinationPath windows-x64-release
          Move-Item -Force -Path windows-x64-release\* -Destination C:/hostedtoolcache/windows/flutter/stable-${{ env.FLUTTER_VERSION }}-x64/bin/cache/artifacts/engine/windows-x64-release/

      - name: Patch flutter
        shell: bash
        run: |
          cp .github/patches/flutter_3.24.4_dropdown_menu_enableFilter.diff $(dirname $(dirname $(which flutter)))
          cd $(dirname $(dirname $(which flutter)))
          [[ "3.24.5" == ${{env.FLUTTER_VERSION}} ]] && git apply flutter_3.24.4_dropdown_menu_enableFilter.diff

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.SCITER_RUST_VERSION }}
          targets: x86_64-pc-windows-msvc
          components: "rustfmt"

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "windows-2022"

      - name: Setup vcpkg with Github Actions binary cache
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: C:\vcpkg
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT_ID }}
          doNotCache: false

      - name: Install vcpkg dependencies
        shell: bash
        run: |
          if ! $VCPKG_ROOT/vcpkg install --triplet x64-windows-static --x-install-root="$VCPKG_ROOT/installed"; then
            find "${VCPKG_ROOT}/" -name "*.log" | while read -r _1; do echo "$_1:"; echo "======"; cat "$_1"; echo "======"; echo ""; done
            exit 1
          fi

      # ==================  è°ƒè¯•æ­¥éª¤  ==================
      - name: "ğŸ§ª Debug: Check Environment Variables before build"
        shell: pwsh
        run: |
          Write-Host "--- Checking RENDEZVOUS_SERVER environment variable ---"
          $server_var = $env:RENDEZVOUS_SERVER
          Write-Host "Value from shell is: [$server_var]"
          if ($server_var) {
            Write-Host "âœ… RENDEZVOUS_SERVER is SET."
          } else {
            Write-Host "âŒ RENDEZVOUS_SERVER is NOT SET or IS EMPTY."
          }
          Write-Host "-----------------------------------------------------"
      # ===============================================

      - name: Build rustdesk binary
        run: |
          python3 .\build.py --portable --hwcodec --flutter --vram --skip-portable-pack
          Move-Item -Path ./flutter/build/windows/x64/runner/Release -Destination ./rustdesk

      - name: Download RustDeskTempTopMostWindow artifacts
        uses: actions/download-artifact@master
        with:
          name: topmostwindow-artifacts
          path: "./rustdesk"

      - name: Upload Build Artifact for Inspection
        uses: actions/upload-artifact@master
        with:
          name: rustdesk-windows-build-test
          path: rustdesk/
